<HTML>
	<HEAD>
		<TITLE>up-periscope</TITLE>

		<style>
			body {
				font-family: Comic Sans MS, sans;
				overflow: hidden;
			}
			.periscope {
				position:absolute;
			}
			.top {
				border: 4px solid black;
				border-radius:100%;
			}
			.inn {
				position:relative;
				height:80%; /* hmmm... */
				border: 4px solid black;
			}
		</style>

		<script type="text/javascript" src="js/functions.js"></script>

		<script type="text/javascript">
			const UpPeriscope = function() {
				const self = this;
				self.init = function() { 
					self.current = new Periscope();
					self.frameFunction = frame( self.draw, 48 );
					self.frameFunction.start();
				};

				self.draw = function() {
					if( self.current.move() ) {
						self.current = new Periscope();
					}
				};

				self.init();
			};

			const r = function() {
				return Math.random();
			};

			const colorClamp = function( color ) {
				for ( let i = 0 ; i < color.length ; i++ ) {
					color[ i ] = Math.floor( Math.max( 0, Math.min( color[ i ], 255 ) ) );
				}
				return color;
			};

			const rgb = function() {
				let color = [0,0,0];
				color[ Math.floor( r() * color.length ) ] = 64;
				for ( let toAllocate = 255 + Math.floor( r() * 255 * 1.3 ) ; toAllocate > 0 ; toAllocate-- ) {
					color[ Math.floor( r() * color.length ) ]++;
				}
				return colorClamp( color );
			};

			const toCssColor = function( color ) {
				return 'rgba(' + color.join( ',' ) + ',1)';
			};

			const Periscope = function() {
				const self = this;
				self.init = function() {
					let colorMain = rgb();

					let change = 1 + ( r() < 0.5 ? +1 : -1 ) * ( 0.15 + r() * 0.33 );
					let colorTop  = [];
					for ( let i = 0 ; i < colorMain.length ; i++ ) {
						colorTop[ i ] = colorMain[ i ] * change;
					}
					colorClamp( colorTop );

					colorMain = toCssColor( colorMain );
					colorTop = toCssColor( colorTop );

					self.main   = document.createElement( 'div' );
					self.top    = document.createElement( 'div' );
					self.inn    = document.createElement( 'div' );

					self.main.appendChild( self.top );
					self.main.appendChild( self.inn );

					self.main   .setAttribute( 'class', 'periscope' );
					self.top    .setAttribute( 'class', 'top' );
					self.inn    .setAttribute( 'class', 'inn' );

					self.top.style.background    = colorTop;

					self.inn.style.backgroundImage = 'linear-gradient(66deg, ' + colorTop + ',' + colorMain + ')';
					if ( r() < 0.1 ) {
						document.body.style.background = self.inn.style.backgroundImage;
					}

					document.body.appendChild( self.main );

					self.height = 33 + 5 + Math.floor( r() * 100 );
					self.main.style.height = self.height + '%';

					self.width = 5 + Math.floor( r() * 30 );
					self.width = 5 + Math.floor( r() * 10 );
					self.main.style.width = self.width + '%';

					self.top.style.height = +( self.width * 0.7 ) + '%';
					self.inn.style.top    = -( self.width * 0.4 ) + '%';

					self.depth = -( 1 + Math.floor( r() * 999 ) ) * 4;
					self.main.style.zIndex = self.top.style.zIndex = self.depth;
					self.inn.style.zIndex = self.depth - 1;

					self.main.style.left = Math.floor( -self.width + r() * ( 100 + self.width ) ) + '%';

					self.goalY = -33;
					self.main.style.bottom = self.goalY + '%';

					self.y = -self.height * 0.50;
					self.main.style.bottom = self.y + '%';

					self.dy = +1;
				};

				self.move = function() {
					if ( Math.abs( self.y - self.goalY ) < 3.44 ) return true;

					// dampening
					//self.dy *= 0.99;

					self.y += self.dy;
					self.main.style.bottom = self.y + '%';

					let inc = 1.77;
					if ( self.y < self.goalY ) { 
						self.dy += inc;
					} else {
						self.dy -= inc;
					}
				};

				self.init();
			};

			window.onload = function() {
				new UpPeriscope();
			};
		</script>
	</HEAD>
	<BODY>
	</BODY>
</HTML>
