<HTML>
	<HEAD>
		<TITLE>slerp_arm</TITLE>

		<!--  S O  -  S T Y L I S H ! : so stylish! -->

		<link rel="stylesheet" href="css/css.css"></link>

		<!--  B I T  -  O '  -  J A V A S C R I P T : bit o' javascript -->

		<script type="text/javascript" src="js/Constantso.js"></script>
		<script type="text/javascript" src="js/Glo.js"></script>
		<script type="text/javascript" src="js/Matrixo.js"></script>
		<script type="text/javascript" src="js/Mesho.js"></script>
		<script type="text/javascript" src="js/Mouseo.js"></script>
		<script type="text/javascript" src="js/Quaterniono.js"></script>
		<script type="text/javascript" src="js/Shaders.js"></script>
		<script type="text/javascript" src="js/Utilo.js"></script>
		<script type="text/javascript" src="js/Vectoro.js"></script>

		<script type="text/javascript">
			const rando = function() { return Math.random(); }

			const Limb = function( length, limbs ) {
				this.init = function( length, limbs ) {
					this.start = this.rando();
					this.stop = this.rando();
					this.length = length;
					this.idk = Quaterniono.set( 0, this.length, 0 );
					if ( limbs ) {
						this.limb = new Limb( 0.77 * length, limbs - 1 );
					}
				};
				this.rando = function() {
					return Quaterniono.rotate(
						rando() * Math.PI * 2
						, Quaterniono.set( rando(), rando(), rando() )
					);
				};

				this.slerp = function( q, t, qz ) {
					let slerped = Quaterniono.slerp( this.start, this.stop, t );
					let rotated = Quaterniono.rotatePoint( slerped, this.idk );
					let next = Quaterniono.add( q, rotated );
					qz.push( next );
					if ( this.limb ) {
						this.limb.slerp( next, t, qz );
					}
				};

				this.init( length, limbs );
			};
			const slerp_arm = function() {
				/* little dom fun */

				let canvas = Utilo.getByTag( 'canvas' );
				let mouseControls = Mouseo.simpleControls( canvas );
				Utilo.getByContents( 'fullscreen' ).onclick = function() { Utilo.fullscreen( canvas ); };

				/* setup */

				let gl = Glo.gl( canvas );
				let program = Glo.program( gl, Shaders.lit.vertex, Shaders.lit.fragment );

				let limb = new Limb( 0.44, 3 );
				console.log( JSON.stringify( limb,(k,v)=>Utilo.floatless(v),'\t' ) );

				let faces    = [ 0,1,2 ];
				let vertices = [ 0,1,0, 1,0,0, 0,0,0 ];
				let colors   = [ 1,0,0, 0,1,0, 0,0,1 ];

				/* drawing loop */

				let t = 0.0;
				let t_velocity_start = 0.01;
				let t_velocity = t_velocity_start;
				let t_acceleration = 1.01;
			
                let draw = function() {
                    Glo.clear( gl );

					//mouseControls.idle( 5000, 0.03 );
					let m = Matrixo.multiply( mouseControls.matrix(), Matrixo.scale( 0.66 ) );
					Glo.matrix( gl, program, 'uMatrix', m );

					let qz = [Quaterniono.set( 0,0,0 )];
					limb.slerp( qz[ 0 ], t, qz );

					// convert to vertices
					let vertices = [];
					for ( let i = 0 ; i < qz.length ; i++ ) {
						for ( let j = 0 ; j < 3 ; j++ ) {
							vertices.push( qz[ i ][ j ] );
						}
					}
					colors = vertices.map((v,i)=>i%3?t:1-t);

					faces = [];
					for ( let i = 0 ; i < qz.length - 1 ; i++ ) {
						faces.push( i + 0 );
						faces.push( i + 1 );
					}

					if ( false ) {
						let msg = JSON.stringify( vertices,(k,v)=>Utilo.floatless(v) );
						console.log( Utilo.floatless( t ) + ': ' + msg );
					}

					t += t_velocity;
					let tClass = t < 0 ? 0 : ( t > 1 ? 1 : 33);
					switch( tClass ) {
						case 0: t = 0; t_velocity = +t_velocity_start; break;
						case 1: t = 1; t_velocity = -t_velocity_start; break;
						default: t_velocity *= t_acceleration;
					}

					Glo.data( gl, program, 'aPosition', vertices );
					Glo.data( gl, program, 'aColor', colors );
					Glo.draw( gl, faces, gl.LINES );

					setTimeout( function() { requestAnimationFrame( draw ) }, 22 );
				};
				draw();
			};
		</script>

		<script type="text/javascript">
			window.onload = slerp_arm;
		</script>
	</HEAD>
	<BODY>
		<lul>
			<canvas width="512" height="512"></canvas>
			<button>fullscreen</button>
			<info>slerp_arm</info>
		</lul>
	</BODY>
</HTML>
