<HTML>
	<HEAD>
		<TITLE>prismatic_sphere</TITLE>

		<!--  S O  -  S T Y L I S H ! : so stylish! -->

		<link rel="stylesheet" href="css/css.css"></link>

		<!--  B I T  -  O '  -  J A V A S C R I P T : bit o' javascript -->

		<script type="text/javascript" src="js/Glo.js"></script>
		<script type="text/javascript" src="js/Matrixo.js"></script>
		<script type="text/javascript" src="js/Shaders.js"></script>
		<script type="text/javascript" src="js/Vectoro.js"></script>
		<script type="text/javascript" src="js/Utilo.js"></script>
		<script type="text/javascript" src="js/model/triangular_prism/TriangularPrism.js"></script>

		<script type="text/javascript">
			const prismatic_sphere = function() {
				let canvas = Utilo.getByTag( 'canvas' );

				let gl = Glo.gl( canvas, {preserveDrawingBuffer:true} );
				let program = Glo.program( gl, Shaders.lit.vertex, Shaders.lit.fragment );
				let textureProgram = Glo.program( gl, Shaders.texture.vertex, Shaders.texture.fragment );

				let vertices = TriangularPrism.vertices;
				let faces = TriangularPrism.faces;

				let edges = facesToEdges( faces );
				let colors = verticesToColors( vertices );
				let inverted = colors.map(function(v){return 1-v});
				let angle = 0;
				let solid = 0;

				canvas.onclick = function() {
					faces = TriangularPrism.subdivide();
					edges = facesToEdges( faces );
					colors = verticesToColors( vertices );
					inverted = colors.map(function(v){return 1-v});
					console.log( [faces.length, 'faces and', vertices.length, 'vertices' ].join( ' ' ) );
				};

				Utilo.getByTag( 'button' ).onclick = function() {
					Utilo.fullscreen( canvas );
				};
			
				document.onkeypress = function() {
					solid++;
				};

				let image = new Image();
				let texture_ready = false;

				let draw = function() {
					Glo.clear( gl );

					/* draw the triangular prism */

					gl.useProgram( program );

					angle += 0.022;
					let c = Math.cos( angle );
					let s = Math.sin( angle );

					Glo.matrix( gl, program, 'uMatrix', 
						Matrixo.multiplyMatrices(
							  Matrixo.rotateX( c, s ) 
							, Matrixo.rotateY( c, s ) 
							, Matrixo.rotateZ( c, s ) 
							, Matrixo.scale( 0.66 ) 
						)
					);	

					Glo.data( gl, program, 'aPosition', vertices );

					switch ( solid % 3 ) {
						case 0:
							Glo.data( gl, program, 'aColor', colors );
							Glo.draw( gl, faces );
						case 1:
							Glo.data( gl, program, 'aColor', inverted );
							Glo.draw( gl, edges, gl.LINES );
							break;
						case 2:
							Glo.data( gl, program, 'aColor', colors );
							Glo.draw( gl, faces );
					}

					/* draw the texture image */

					if ( texture_ready ) {
						gl.useProgram( textureProgram );
						Glo.data( gl, textureProgram, 'aPosition', [ -1,+1, 0.9,  +0,+1,0.9,  -1,+0, 0.9,  +0,+0,0.9 ] );
						Glo.data( gl, textureProgram, 'aTexture', [ 0,0,  1,0,  0,1,  1,1 ], 2);
						Glo.draw( gl, [ 0, 1, 2,	1, 3, 2 ] );
					}

					canvas.toBlob(function(blob) {
						document.body.style.background = 'url(' + canvas.toDataURL('image/png') + ')';
						let url = URL.createObjectURL( blob );
						image.onload = function() {
							Glo.textureSetup( gl, program, image );
							Glo.texture( gl, program, 'uSampler', image );
							texture_ready = true;

							URL.revokeObjectURL( url );
							setTimeout( function() { requestAnimationFrame( draw ) }, 22 );
  						};
						image.src = url;
					})
				};
				draw();
			};

			const facesToEdges = function( faces ) {
				let edges = [];
				for ( let i = 0 ; i < faces.length ; i += 3 ) {
					edges.push( faces[ i + 0 ] );
					edges.push( faces[ i + 1 ] );
					edges.push( faces[ i + 1 ] );
					edges.push( faces[ i + 2 ] );
					edges.push( faces[ i + 2 ] );
					edges.push( faces[ i + 0 ] );
				}
				return edges;
			};

			const verticesToColors = function( vertices ) {
				return vertices.map( function( v ) { return 0.5 * ( 1 + v ) } );
			};
		</script>

		<script type="text/javascript">
			window.onload = prismatic_sphere;
		</script>

		<style>
			button {
				width:512px;
				margin:auto;
				display:block;
			}
		</style>
	</HEAD>
	<BODY>
		<canvas width="512" height="512"></canvas>
		<button style="width:512px;margin:auto;display:block;">fullscreen</button>
		<info>click to subdivide sphere</info>
		<info>press any key to change drawing mode</info>
	</BODY>
</HTML>
